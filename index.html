<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>development-container: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">development-container
   </div>
   <div id="projectbrief">ROS2 starter project with graphics</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">development-container Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_README"></a> <a href="https://github.com/PickNikRobotics/ros_testing_templates/actions/workflows/ci.yaml"><img src="https://github.com/PickNikRobotics/ros_testing_templates/actions/workflows/ci.yaml/badge.svg" alt="ci" style="pointer-events: none;" class="inline"/></a> </p>
<h1><a class="anchor" id="autotoc_md0"></a>
development-container</h1>
<p>The development container allows developers to sandbox repository dependencies from their host machine while allowing them to use familiar development tools.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
TL;DR</h1>
<p>Build a new development image</p>
<p><b>Note</b>: The <code>REPO</code> variable is defined in <code>.env</code></p>
<div class="fragment"><div class="line">source .env</div>
<div class="line">mkdir -p ~/.${REPO}/ccache</div>
<div class="line">export UIDGID=$(id -u):$(id -g); docker compose -f compose.dev.yml build</div>
</div><!-- fragment --><p> Start an interactive development container </p><div class="fragment"><div class="line">docker compose -f compose.dev.yml run development</div>
</div><!-- fragment --><p> Build the repository in the container </p><div class="fragment"><div class="line">username@development-container-dev:~/ws$ colcon build</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md2"></a>
Test</h1>
<p>To test that your container is working with graphics </p><div class="fragment"><div class="line">username@development-container-dev:~/ws$ colcon build</div>
<div class="line">username@development-container-dev:~/ws$ source install/setup.bash</div>
<div class="line">username@development-container-dev:~/ws$ ros2 launch platform_description display.launch.py</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md3"></a>
Dependencies</h4>
<p>Repository dependencies are built into the development image. This insulates the developer from potentially conflicting dependencies on their host while preventing development from accidentally depending on host packages and configurations. This uniform development environment should also make it easier for developers to collaboratively troubleshoot issues.</p>
<h4><a class="anchor" id="autotoc_md4"></a>
Rebuilding image</h4>
<p>As repository dependencies change, the development image will have to be rebuilt. While early on this can happen frequently, dependencies tend to change more slowly later in a project. Unless otherwise noted, it is a good habit to update your image once a sprint.</p>
<h4><a class="anchor" id="autotoc_md5"></a>
&lt;a id="ccache"&gt;&lt;/a&gt; ccache</h4>
<p><code>ccache</code> allows previous builds to speed up future builds. As the container is not persistent, we need to map the cache to the host so it can be reused in subsequent instantiations of the container. On the host, create the cache directory </p><div class="fragment"><div class="line">mkdir -p ~/.${REPO}/ccache</div>
</div><!-- fragment --><p> This will then be mapped to <code>/home/username/.ccache</code> in the container.</p>
<h4><a class="anchor" id="autotoc_md6"></a>
Volume mapping</h4>
<p>While the container itself by default is not persistent, several host directories are mapped into the container including</p><ul>
<li>repository source code</li>
<li>ssh keys</li>
<li>git configuration</li>
<li>host credentials</li>
<li>X11 connection</li>
</ul>
<p>This allows for a more seamless development environment for</p><ul>
<li>building source</li>
<li>in container committing with your user</li>
<li>graphical tool use</li>
</ul>
<p>The full set of volume maps can be read in the <a href="compose.dev.yml">compose file</a>.</p>
<h4><a class="anchor" id="autotoc_md7"></a>
git</h4>
<p>Commits can be done from directly within the container, with the same host user. </p><div class="fragment"><div class="line">username@development-container-dev:~/ws/src$ git config --list</div>
<div class="line">user.email=firstname.lastname@email.com</div>
<div class="line">user.name=Firstname Lastname</div>
<div class="line">core.editor=vim</div>
<div class="line">core.repositoryformatversion=0</div>
<div class="line">core.filemode=true</div>
<div class="line">core.bare=false</div>
<div class="line">core.logallrefupdates=true</div>
<div class="line">remote.origin.url=git@github.com:griswaldbrooks/development-container.git</div>
<div class="line">remote.origin.fetch=+refs/heads/*:refs/remotes/origin/*</div>
<div class="line">branch.main.remote=origin</div>
<div class="line">branch.main.merge=refs/heads/main</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md8"></a>
Graphics</h4>
<p>Running rviz from within the container should produce a graphical window on the host.</p>
<div class="fragment"><div class="line">username@development-container-dev:~/ws/src$ rviz2</div>
</div><!-- fragment --><p> <img src="rviz2.png" alt="" class="inline" title="Rviz2"/></p>
<h4><a class="anchor" id="autotoc_md9"></a>
Editing</h4>
<p>As the repository source is volume mapped into the container, it can be edited outside of the container and changes are immediately reflected inside the container. This means you can use your existing host tools (vim, atom, sublime, vs code) to develop, and build in the container.</p>
<h1><a class="anchor" id="autotoc_md10"></a>
Prerequisites</h1>
<h2><a class="anchor" id="autotoc_md11"></a>
docker</h2>
<p>Taken from <a href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a></p>
<h4><a class="anchor" id="autotoc_md12"></a>
Check version</h4>
<p>If docker is already installed, the below steps may not be required </p><div class="fragment"><div class="line">$ docker version</div>
<div class="line">Client: Docker Engine - Community</div>
<div class="line"> Version:           20.10.12</div>
<div class="line"> API version:       1.41</div>
<div class="line"> Go version:        go1.16.12</div>
<div class="line"> Git commit:        e91ed57</div>
<div class="line"> Built:             Mon Dec 13 11:45:33 2021</div>
<div class="line"> OS/Arch:           linux/amd64</div>
<div class="line"> Context:           default</div>
<div class="line"> Experimental:      true</div>
<div class="line"> </div>
<div class="line">Server: Docker Engine - Community</div>
<div class="line"> Engine:</div>
<div class="line">  Version:          20.10.12</div>
<div class="line">  API version:      1.41 (minimum version 1.12)</div>
<div class="line">  Go version:       go1.16.12</div>
<div class="line">  Git commit:       459d0df</div>
<div class="line">  Built:            Mon Dec 13 11:43:42 2021</div>
<div class="line">  OS/Arch:          linux/amd64</div>
<div class="line">  Experimental:     false</div>
<div class="line"> containerd:</div>
<div class="line">  Version:          1.4.13</div>
<div class="line">  GitCommit:        9cc61520f4cd876b86e77edfeb88fbcd536d1f9d</div>
<div class="line"> runc:</div>
<div class="line">  Version:          1.0.3</div>
<div class="line">  GitCommit:        v1.0.3-0-gf46b6ba</div>
<div class="line"> docker-init:</div>
<div class="line">  Version:          0.19.0</div>
<div class="line">  GitCommit:        de40ad0</div>
</div><!-- fragment --><p> The development image was tested with version 20.10.12.</p>
<h4><a class="anchor" id="autotoc_md13"></a>
Download and install</h4>
<div class="fragment"><div class="line">curl -fsSL https://get.docker.com -o get-docker.sh</div>
<div class="line">sudo sh get-docker.sh</div>
</div><!-- fragment --><p> Note, the above script does not cover removing old versions.</p>
<h4><a class="anchor" id="autotoc_md14"></a>
Post actions</h4>
<p>Adding yourself to the <code>docker</code> group and refreshing shell obviates the need to run <code>sudo</code> with <code>docker</code>. </p><div class="fragment"><div class="line">sudo groupadd docker</div>
<div class="line">sudo usermod -aG docker $USER</div>
<div class="line">newgrp docker</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md15"></a>
docker compose v2</h2>
<p>Taken from <a href="https://docs.docker.com/compose/cli-command/#install-on-linux">https://docs.docker.com/compose/cli-command/#install-on-linux</a></p>
<h4><a class="anchor" id="autotoc_md16"></a>
Download release</h4>
<div class="fragment"><div class="line">DOCKER_CONFIG=${DOCKER_CONFIG:-$HOME/.docker}</div>
<div class="line">mkdir -p $DOCKER_CONFIG/cli-plugins</div>
<div class="line">curl -SL https://github.com/docker/compose/releases/download/v2.2.3/docker-compose-linux-x86_64 -o $DOCKER_CONFIG/cli-plugins/docker-compose</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md17"></a>
Apply permissions</h4>
<div class="fragment"><div class="line">chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md18"></a>
Test</h4>
<div class="fragment"><div class="line">docker compose version</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md19"></a>
nvidia-docker</h2>
<p>TODO: It is unconfirmed if <code>nvidia-docker</code> is required on hosts with nvidia gpus. Currently, <code>rviz2</code> has been tested with</p><ul>
<li><code>nvidia-docker</code> and nvidia gpu</li>
<li>no <code>nvidia-docker</code> and intel gpu and it produced comparable frame rates to the host. There is also a question if this is obviated by installing the gpu driver in the container and if that is best practice.</li>
</ul>
<h1><a class="anchor" id="autotoc_md20"></a>
Alias</h1>
<p>While developing a tool on top of another tool can come with challenges, some may prefer to at least have some simple aliases to reduce the typing boilerplate. </p><div class="fragment"><div class="line">alias builddev=&quot;export UIDGID=$(id -u):$(id -g); docker compose -f compose.dev.yml build&quot;</div>
<div class="line">alias rundev=&quot;export UIDGID=$(id -u):$(id -g); docker compose -f compose.dev.yml run development&quot;</div>
</div><!-- fragment --><p>As an aside, a handy way to find a previous command is </p><div class="fragment"><div class="line">history | grep keyword</div>
</div><!-- fragment --><p> to rerun the command using the offset number given from <code>history</code> </p><div class="fragment"><div class="line">!offsetnumber</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md21"></a>
Troubleshooting</h1>
<h4><a class="anchor" id="autotoc_md22"></a>
ccache cannot compile</h4>
<div class="fragment"><div class="line">&quot;/usr/lib/ccache/cc&quot;</div>
<div class="line"> </div>
<div class="line">  is not able to compile a simple test program.</div>
</div><!-- fragment --><p> Likely, the host ccache directory in your <a href="#ccache">home directory</a> was not created properly. Ensure that the directory is created and owned by the host user. </p><div class="fragment"><div class="line">mkdir -p ~/.${REPO}/ccache</div>
<div class="line">sudo chown -R $(id -u):$(id -g) ~/.${REPO}/ccache</div>
</div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
